p8105\_hw6\_yf2563
================
Yatong Feng
12/7/2020

``` r
library(tidyverse)

knitr::opts_chunk$set(
  message = F,
  warning = F
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

The Washington Post has gathered data on homicides in 50 large U.S.
cities.

  - Create a city\_state variable (e.g. “Baltimore, MD”)
  - binary variable indicating whether the homicide is solved.
  - Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these
    don’t report victim race.
  - omit Tulsa, AL – this is a data entry mistake.
  - For this problem, limit your analysis those for whom victim\_race is
    white or black.
  - Be sure that victim\_age is numeric.

<!-- end list -->

``` r
homicide_df = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    city_state != "Tulsa, AL") %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)

head(homicide_df)
```

    ## # A tibble: 6 x 5
    ##   city_state      resolution victim_age victim_race victim_sex
    ##   <chr>                <dbl>      <dbl> <chr>       <chr>     
    ## 1 Albuquerque, NM          0         15 White       Female    
    ## 2 Albuquerque, NM          0         72 White       Female    
    ## 3 Albuquerque, NM          0         91 White       Female    
    ## 4 Albuquerque, NM          0         56 White       Male      
    ## 5 Albuquerque, NM          0         NA White       Male      
    ## 6 Albuquerque, NM          1         43 White       Female

For the city of Baltimore, MD:

  - use the glm function to fit a logistic regression with resolved vs
    unresolved as the outcome and victim age, sex and race as
    predictors.
  - Save the output of glm as an R object;
  - apply the broom::tidy to this object;
  - obtain the estimate and confidence interval of the adjusted odds
    ratio for solving homicides comparing non-white victims to white
    victims keeping all other variables fixed.

<!-- end list -->

``` r
baltimore_df =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")
glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
```

| term              |    OR | CI\_lower | CI\_upper |
| :---------------- | ----: | --------: | --------: |
| (Intercept)       | 1.363 |     0.975 |     1.907 |
| victim\_age       | 0.993 |     0.987 |     1.000 |
| victim\_raceWhite | 2.320 |     1.648 |     3.268 |
| victim\_sexMale   | 0.426 |     0.325 |     0.558 |

  - Now run glm for each of the cities in your dataset,
  - extract the adjusted odds ratio (and CI) for solving homicides
    comparing Black victims to white victims.
  - Do this within a “tidy” pipeline, making use of purrr::map, list
    columns, and unnest as necessary to create a dataframe with
    estimated ORs and CIs for each city.

<!-- end list -->

``` r
models_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI")) 
```
